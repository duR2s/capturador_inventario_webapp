<div class="wrapper-captura">

  <!-- CARD PRINCIPAL -->
  <div class="card-flotante">

    <div class="section-form">

      <!-- Botón Toggle Imagen (Móvil) -->
      <button class="mobile-toggle-btn" (click)="toggleMobileImage()">
        <mat-icon>{{ isMobileImageExpanded ? 'keyboard_arrow_down' : 'keyboard_arrow_up' }}</mat-icon>
      </button>

      <div class="header">
        <h2 class="title-captura">
          {{ isEditMode ? 'Editar Captura' : 'Captura Rápida' }}
        </h2>
        <button mat-icon-button (click)="cerrar()" *ngIf="dialogRef" class="close-btn">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <!--
          CAMBIO CRÍTICO:
          1. Cambiado <form> por <div>.
          2. Eliminado (submit).
          3. Eliminado botón hidden.
      -->
      <div [formGroup]="form" class="form-grid" (keydown.enter)="$event.stopPropagation()">

        <!-- Botón Móvil: Type button y (click) manual -->
        <button type="button" class="btn-mobile-floating"
                [disabled]="form.invalid || isLoading"
                (click)="guardar()">
            <mat-icon>check_circle</mat-icon>
            <span>REGISTRAR CAPTURA</span>
        </button>

        <!-- 1. CÓDIGO -->
        <mat-form-field appearance="outline" class="pill-input">
          <mat-label>Código / Barras</mat-label>
          <!--
             MEJORAS MÓVIL:
             1. enterkeyhint="search": Muestra botón 'Buscar'/'Ir' en teclado virtual.
             2. (keyup.enter): Más compatible con teclados móviles que keydown.
             3. Botón matSuffix: Permite disparar la búsqueda tocando el icono.
          -->
          <input matInput formControlName="codigo"
                 #codigoInput
                 (keyup.enter)="onCodigoEnter()"
                 enterkeyhint="search"
                 autocomplete="off"
                 placeholder="Escanea...">

          <mat-icon matPrefix>qr_code_scanner</mat-icon>

          <!-- Spinner de carga -->
          <mat-spinner *ngIf="isLoading" diameter="20" matSuffix></mat-spinner>

          <!-- Botón de búsqueda manual (visible si no carga) -->
          <button *ngIf="!isLoading"
                  mat-icon-button
                  matSuffix
                  type="button"
                  (click)="onCodigoEnter()"
                  aria-label="Buscar"
                  tabindex="-1">
            <mat-icon>search</mat-icon>
          </button>
        </mat-form-field>

        <!-- 2. NOMBRE -->
        <mat-form-field appearance="outline" class="pill-input name-field">
          <mat-label>Descripción</mat-label>
          <input matInput formControlName="nombre" readonly tabindex="-1">
          <!-- Botón para abrir modal de búsqueda avanzada -->
          <button mat-icon-button matSuffix type="button" (click)="abrirBusqueda()" class="search-btn" matTooltip="Búsqueda avanzada">
            <mat-icon>list</mat-icon>
          </button>
        </mat-form-field>

         <!-- 3. CAMPO CANTIDAD -->
        <mat-form-field appearance="outline" class="pill-input cantidad-field">
          <mat-label>Cantidad</mat-label>
          <input matInput #cantidadInput
                 type="number"
                 formControlName="cantidad"
                 placeholder="0"
                 (keydown.enter)="onCantidadEnter()"
                 enterkeyhint="done">
          <span matSuffix class="unit-suffix">pzas</span>
        </mat-form-field>

        <!-- ERROR MESSAGE -->
        <div class="error-feedback" *ngIf="errorMessage">
            {{ errorMessage }}
        </div>

        <!-- ACCIONES DESKTOP: Type button y (click) manual -->
        <div class="actions" *ngIf="isEditMode">
          <button type="button" class="btn-guardar"
                  [disabled]="form.invalid || isLoading"
                  (click)="guardar()">
            <mat-icon>check</mat-icon>
            CONFIRMAR CAMBIOS
          </button>
        </div>

      </div>
    </div>

    <!-- SECCIÓN A: IMAGEN -->
    <div class="section-image" [class.expanded]="isMobileImageExpanded">
      <div class="image-placeholder" *ngIf="!currentImageUrl">
        <mat-icon>image_not_supported</mat-icon>
        <span>Sin Imagen</span>
      </div>
      <img *ngIf="currentImageUrl" [src]="currentImageUrl" alt="Producto" class="product-image">
      <div class="mobile-overlay"></div>
    </div>

  </div>
</div>
